{{#each proxies as |proxyConfig proxyLocationMatch|}}
  {{#each proxyConfig.upstreams as |upstream version|}}
    upstream {{slug proxyLocationMatch}}_{{ version }} {
      {{#each upstream}}
        server {{this}};
      {{/each}}
    }
  {{/each}}

  map $http_accept ${{slug proxyLocationMatch}}_version {
    # default
    {{# if proxyConfig.default }}
      default {{ slug proxyLocationMatch }}_{{ proxyConfig.default }};
    {{/if }}

    # defined versions
    {{#each proxyConfig.upstreams as |upstream version|}}
      {{> versionMatch version=version }} {{ slug proxyLocationMatch }}_{{ version }};
    {{/each}}

    # unsatisfiable
    {{> versionNoMatch upstreams=proxyConfig.upstreams }} unsatisfiable_version;
  }
{{/each}}
